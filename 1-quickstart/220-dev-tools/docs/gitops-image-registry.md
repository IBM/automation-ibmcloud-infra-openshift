# Image Registry GitOps module

Module to populate a gitops repo with the configuration needed to access an image registry, using a config maps and secrets. This configuration is used by the CI pipelines running in the cluster to enable them to push images to the image registry.

There are three resources generated by this module:

- `registry-config` config map - Contains the url used to access the image registry using a browser and annotations used by the console-link-cronjob process to generate a ConsoleLink application menu.
- `registry-access` secret - Contains the server, username, and password needed to authenticate to the image registry using `docker login`. The secret also contains the registry namespace where images should be pushed.
- docker-registry secret - The secret is named according to the host value (e.g. `us-icr-io` or `docker-io`) and contains the docker config json that can be used to access the image registry

Both of the secrets are encrypted with the kubeseal process and go into the repository as encrypted SealedSecrets that are decrypted by the kube seal operator in the cluster.

## Software dependencies

The module depends on the following software components:

### Command-line tools

- terraform >= v0.15
- kubectl

### Terraform providers

- Null provider

## Module dependencies

This module makes use of the output from other modules:

- GitOps 
    - github.com/cloud-native-toolkit/terraform-tools-gitops.git
- Namespace 
    - github.com/cloud-native-toolkit/terraform-gitops-namespace.git
- Registry 
    - github.com/cloud-native-toolkit/terraform-ibm-container-registry.git
- ArgoCD Bootstrap
    - github.com/cloud-native-toolkit/terraform-tools-argocd-bootstrap.git
    - github.com/cloud-native-toolkit/terraform-vsi-argocd-bootstrap.git

## Example usage

```hcl-terraform
module "gitops_image_registry" {
  source = "github.com/cloud-native-toolkit/terraform-gitops-image-registry.git"

  gitops_config = module.gitops.gitops_config
  git_credentials = module.gitops.git_credentials
  namespace = module.gitops_namespace.name
  registry_server = module.icr.registry_server
  registry_user = module.icr.registry_user
  registry_password = module.icr.registry_password
  registry_namespace = module.icr.registry_namespace
  registry_url = module.icr.registry_url
  kubeseal_cert = module.argocd-bootstrap.sealed_secrets_cert
}

```

